#!/bin/bash

set -euo pipefail
export GO111MODULE=on
gqlgen_dir=$(pwd)
cd $(mktemp -d)
go mod init inittest
printf '//go:build tools\npackage tools\nimport _ "github.com/OldBigBuddha/gqlgen"' | gofmt > tools.go
go mod tidy
go mod edit -replace=github.com/OldBigBuddha/gqlgen="$gqlgen_dir"
go mod tidy

if ! go run github.com/OldBigBuddha/gqlgen init ; then
    echo "gqlgen init failed"
    exit 125
fi

if ! go run github.com/OldBigBuddha/gqlgen generate ; then
    echo "gqlgen generate failed"
    exit 125
fi
